let mapShowed = false

function elementInViewport(el) {
    let top = el.offsetTop
    let left = el.offsetLeft
    let width = el.offsetWidth
    let height = el.offsetHeight

    while (el.offsetParent) {
        el = el.offsetParent
        top += el.offsetTop
        left += el.offsetLeft
    }

    return (
        top < (window.pageYOffset + window.innerHeight) &&
        left < (window.pageXOffset + window.innerWidth) &&
        (top + height) > window.pageYOffset &&
        (left + width) > window.pageXOffset
    )
}

function initMap() {
    if (document.getElementById('map') && elementInViewport(document.getElementById('map')) && !mapShowed) {

        let map,
            pin,
            marker

        mapShowed = true

        let script = document.createElement("script")
        script.src = template_path + "js/leaflet.min.js"
        document.getElementsByTagName("body")[0].appendChild(script)
        script.onload = function () {
            map = L.map('map', {
                attributionControl: false,
                scrollWheelZoom: false
            }).setView([document.getElementById('map').getAttribute('data-lat'), document.getElementById('map').getAttribute('data-lng')], 16)
            L.tileLayer('https://{s}.basemaps.cartocdn.com/light_all/{z}/{x}/{y}{r}.png').addTo(map)
            pin = L.icon({
                iconUrl: template_path + 'images/logo-pin.svg',
                iconSize: [120, 60],
                iconAnchor: [15, 60],
            })
            marker = L.marker([document.getElementById('map').getAttribute('data-lat'), document.getElementById('map').getAttribute('data-lng')], {icon: pin})
            map.addLayer(marker)
        }

        const mapPoints = document.querySelectorAll('.button-switch')
        for (let i = 0; i < mapPoints.length; i++) {
            mapPoints[i].addEventListener('click', function (event) {
                let element = event.target
                map.panTo(element.getAttribute('data-latlng').split(','))
                map.removeLayer(marker)
                marker = L.marker(element.getAttribute('data-latlng').split(','), {icon: pin})
                map.addLayer(marker)
                event.preventDefault()
            })
        }
    }
}

document.addEventListener('DOMContentLoaded', () => {
    initMap()
})

window.addEventListener('scroll', () => {
    initMap()
})